#!/usr/bin/env python

#  Options:
#  select -- selects game
#  clean -- completely cleans currently selected game from Cocos2d-x environment.
#     git clean -f -d <path>   -- removes all untracked files
#  --copy-only-source -- copy only config and src files
#

from datetime import datetime
from subprocess import call

import json
import os
import re
import shutil
import sys

CPATH = "/Users/eric/git/Cocos2d-x_v3.8.1/"
JSON = "/Users/eric/git/LittleGhostBoy/config.json"

fh = open(JSON, "r")
json_blob = fh.read()
fh.close()

config = json.loads(json_blob)

print("ugf-select v1.0.0, Time: {}".format(str(datetime.now())))
print("Project: {} v{} b{}".format(config["name"], config["version"], config["build"]))

# Load and save any changes made to the project to the current project
# NOTE: I'm not sure this is necessary.

# Load the target project - config.json

# Save the target project as the current project
# NOTE: I'm not sure this is necessary.

# If the project does not exist, take the template for the given version of Cocos2d-x and replace all
# instances of the template name 'GameTools' with the target app's name.

# Interpolate template files: (The app will raise an exception if the files below do not contain the tags)
"""
  templates/config.lua (src/config.lua)
    - UGF-DESIGN-WIDTH = config.design.width
    - UGF-DESIGN-HEIGHT = config.design.height
    - GF-SHOW-FPS = (CLI Switch) --show-fps then: true, else: false

  templates/ios/GameTools.xcodeproj/project.pbxproj
    - UGF-APP-BUNDLE = config.bundle
    - UGF-APP-NAME = config.name
    - UGF-APP-VERSION = config.version
    - UGF-APP-BUILD = config.build
    - UGF-DEVICE = config.device
    - UGF-ORIENTATION.* = config.orientation
    - UGF-FACEBOOK-ID = config.facebook.id
  templates/ios/*.plist
    - UGF-APP-NAME = config.name (bundle display name)
  templates/ios/Prefix.pch
    - UGF-HOCKEY-APP-ID = config.hockey.id
    - UGF-ADCOLONY-APP-ID = config.ios.adcolony.id
    - UGF-ADCOLONY-ZONES = config.ios.adcolony.zones

  Special cases:
    - UGF-IOS-ORIENTATION-LANDSCAPE = config.design.orientation (landscape)
    - UGF-IOS-ORIENTATION-LANDSCAPE = config.design.orientation (landscape)
    - UGF-IOS-ORIENTATION-PORTRAIT = config.design.orientation (portrait)
    - UGF-ANDROID-ORIENTATION-LANDSCAPE
    - UGF-ANDROID-ORIENTATION-PORTRAIT

  Possible. For now, just comment out.:
    - UGF-FACEBOOK-IOS = config.facebook.enabled
    - UGF-FACEBOOK-ANDROID = ?
    - UGF-ADCOLONY-IOS = config.adcolony.ios.enabled, writes: configureAdColony method
"""

TPL_PATH = CPATH + "stage/"

if not os.path.exists(TPL_PATH):
    os.makedirs(TPL_PATH)

# , "##UGF-ADCOLONY-APP-ZONES##": '", @"'.join(config["mediation"]["ios"]["adcolony"]["zones"])
keys = {
    "##UGF-APP-BUNDLE##": config["bundle"]
  , "##UGF-APP-NAME##": config["name"]
  , "##UGF-APP-VERSION##": config["version"]
  , "##UGF-APP-BUILD##": config["build"]
  , "##UGF-EXECUTABLE##": config["executable"]
  , "##UGF-HOCKEY-APP-ID##": config["hockey"]["id"]
  , "##UGF-ADCOLONY-APP-ID##": config["mediation"]["ios"]["adcolony"]["id"]
  , "##UGF-ADCOLONY-APP-ZONES##": ",".join(config["mediation"]["ios"]["adcolony"]["zones"])
  , "##UGF-FACEBOOK-ID##": config["facebook"]["id"]
  , "##UGF-DESIGN-WIDTH##": config["design"]["width"]
  , "##UGF-DESIGN-HEIGHT##": config["design"]["height"]
  , "##UGF-SHOW-FPS##": "false"
  , "##UGF-ORIENTATION##": config["orientation"]
}

# The pbxproj does not need to be a template.
shutil.copyfile(CPATH + "frameworks/runtime-src/proj.ios_mac/GameTools.xcodeproj/project.pbxproj", CPATH + "stage/project.pbxproj")

iOS_plist = "templates/ios/Info.plist"
iOS_Prefix = "templates/ios/Prefix.pch"

files = {
    iOS_plist: "frameworks/runtime-src/proj.ios_mac/ios/Info.plist"
  , iOS_Prefix: "frameworks/runtime-src/proj.ios_mac/ios/Prefix.pch"
  , "stage/project.pbxproj": "frameworks/runtime-src/proj.ios_mac/GameTools.xcodeproj/project.pbxproj"
  , "templates/config.lua": "src/config.lua"
}

for tpl, target in files.iteritems():
    # Read
    fh = open(CPATH + tpl, "r")
    blob = fh.read()
    for key, val in keys.iteritems():
        blob = re.sub(key, str(val), blob)
    if iOS_plist:
        # @note These replacements MUST be done in order.
        blob = re.sub("productName = GameTools;", "productName = {};".format(config["executable"]), blob)
        blob = re.sub("PRODUCT_BUNDLE_IDENTIFIER = com.upstartillustration.GameTools;", "PRODUCT_BUNDLE_IDENTIFIER = {};".format(config["bundle"]), blob)

        blob = re.sub("GameTools-mobile.app", "{}-mobile.app".format(config["executable"]), blob)
        blob = re.sub("\/\* GameTools-mobile \*\/", "/* {}-mobile */".format(config["executable"]), blob)
        blob = re.sub('"GameTools-mobile"', '"{}-mobile"'.format(config["executable"]), blob)

        blob = re.sub("GameTools-desktop.app", "{}-desktop.app".format(config["executable"]), blob)
        blob = re.sub("\/\* GameTools-desktop \*\/", "/* {}-desktop */".format(config["executable"]), blob)
        blob = re.sub('"GameTools-desktop"', '"{}-desktop"'.format(config["executable"]), blob)

        blob = re.sub('"GameTools"', '"{}"'.format(config["executable"]), blob)
    elif tpl == iOS_Prefix:
        c = None
        if config["orientation"] == "landscape":
            c = """<string>UIInterfaceOrientationLandscapeRight</string>
            <string>UIInterfaceOrientationLandscapeLeft</string>"""
        else:
            c = """<string>UIInterfaceOrientationPortrait</string>"""
        blob = re.sub("##UGF-ORIENTATION-IOS##", c)
    fh.close()
    # Write
    stagepath = CPATH + "stage/" + os.path.split(tpl)[1]
    fh = open(stagepath, "w")
    fh.write(blob)
    fh.close()
    # Copy to target location.
    shutil.copyfile(stagepath, CPATH + target)

# @todo Cleanup stage directory

# The orientation config may need to be specific to files so that operations are checked correctly, but also that
# some options are removed!

# Copy interpolated file to correct location.
# NOTE: Make it so all of the config for the app lives in this file, including AdMob interstitial info, etc.

# Copy Xcode assets
call(["rm", "-rf", "/Users/eric/git/Cocos2d-x_v3.8.1/frameworks/runtime-src/proj.ios_mac/GameTools-mobile/Images.xcassets/AppIcon.appiconset"])
call(["rm", "-rf", "/Users/eric/git/Cocos2d-x_v3.8.1/frameworks/runtime-src/proj.ios_mac/GameTools-mobile/Images.xcassets/LaunchImage.launchimage"])

call(["cp", "-r", "/Users/eric/git/LittleGhostBoy/platform/ios/res/Images.xcassets", "/Users/eric/git/Cocos2d-x_v3.8.1/frameworks/runtime-src/proj.ios_mac/GameTools-mobile/"])

# Copy Android assets

# Copy GameTools
call(["rm", "-rf", "/Users/eric/git/Cocos2d-x_v3.8.1/src/ugf"])
call(["cp", "-r", "/Users/eric/git/GameTools/src/", "/Users/eric/git/Cocos2d-x_v3.8.1/src/ugf"])

# Copy game source and assets
call(["rm", "-rf", "/Users/eric/git/Cocos2d-x_v3.8.1/src/game"])
call(["cp", "-r", "/Users/eric/git/LittleGhostBoy/src/", "/Users/eric/git/Cocos2d-x_v3.8.1/src/game"])

call(["rm", "-rf", "/Users/eric/git/Cocos2d-x_v3.8.1/res"])
call(["cp", "-r", "/Users/eric/git/LittleGhostBoy/res", "/Users/eric/git/Cocos2d-x_v3.8.1/res"])

# Update a compile time script that will call this script with the currently selected project before build
# so that all of the latest code is copied.

#call(["git", "clean", "-f", "-d", CPATH])
#call(["git", "checkout", CPATH])
